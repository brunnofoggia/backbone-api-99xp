/**
* @license
* backbone-api 99xp
* ----------------------------------
* v0.7.0-beta
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-api.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("validate-99xp"),require("backbone-request-99xp"),require("app-exception")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","validate-99xp","backbone-request-99xp","app-exception"],e):e((t=t||self).BackboneApi={},t._,t.v,t.BackboneRequest,t.AppException)}(this,function(t,r,i,s,o){"use strict";r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i,s=s&&s.hasOwnProperty("default")?s.default:s,o=o&&o.hasOwnProperty("default")?o.default:o;var a={_res:null},n={idAttribute:"_id",auth:!1,tokenField:"accessToken",methods:{},setAuthHeader(t){return this.tokenField?(t.headers.Authorization="Bearer "+this.data[this.auth][this.tokenField],t):a.error("tokenField is not set")},isAuthenticated(){return!this.auth||!!this.data[this.auth]},initialize(t,e={}){this.setRouterParameters(e.req,e.res),this.options=r.defaults(r.omit(e,"req","res"),{autoexec:!0}),this.data={},this.dataSent={},"string"==typeof this.options.method&&(this.options.method=[this.options.method]),this.options.autoexec&&this.execAll()},execAll(){if(!this._methodsExecution&&(this._methodsExecution=r.clone(this.options.method)),0===r.size(this._methodsExecution))return this._methodsExecution=null,void r.bind(this.options.success,this)();var t=this._methodsExecution.shift();this.exec(t,()=>this.execAll(),this.options.error)},exec(t,e,i){var s,o=this.methodData(t);if(null!==(s=this.validate(this._req.body||{},{methodData:o,validationsKey:"inputValidations"})))return this.validationErrors(s);if(o=this.methodDataCompose(o),null!==(s=this.validate(o.sendData,{methodData:o})))return this.validationErrors(s);var n=r.bind(this.callApi,this),h=r.partial(n,t,o,e,i);return o.public||this.isAuthenticated()?h():this.auth?this.exec(this.auth,h,i):a.error(`method "${t}" is not set as public but auth is not set`)},callApi(t,e,i,s){this.setApiCall(e),this.dataSent[t]=e.sendData;var o={method:e.method,data:e.sendData,headers:r.result2(e,"headers",{},[e],this)};e.public||(o=this.setAuthHeader(o));var n=r.bind("function"==typeof e.before?e.before:(t,e,r)=>{t(e,r)},this),h=r.bind(r.partial((t,e,i,s,o)=>{this.listenToOnce(this,"sync",r.bind(()=>{this.stopListening(this),this.data[t]=this.attributes,this.attributes={};try{"function"==typeof e.success&&r.bind(e.success,this)(o,this._req.body,e),"function"==typeof i&&r.bind(i,this)(o,this._req.body,e)}catch(t){var n={error:"Internal Failure (1)"};"function"==typeof s?s(n):a.error(n)}},this)),this.listenToOnce(this,"error",r.bind((t,i)=>{this.stopListening(this);try{var n;"function"==typeof e.error&&r.bind(e.error,this)(i,o,this._req.body,e),"function"==typeof s?r.bind(s,this)(i,o,this._req.body,e):a.error(null==i?void 0:i.error,0,(null==i?void 0:null===(n=i.response)||void 0===n?void 0:n.statusCode)||500)}catch(t){a.error({title:"Internal Server Error",errors:t},3)}},this)),this.save(null,o)},t,e,i,s),this);try{n(h,o,e,s)}catch(t){var d,u={error:"Internal Failure (4)"};"function"==typeof s?r.bind(s,this)(u,o,this._req.body,e):a.error(null==u?void 0:u.error,0,(null==u?void 0:null===(d=u.response)||void 0===d?void 0:d.statusCode)||500)}},methodData(t){if(!t||!r.result(this,"methods")[t])return a.error("Make sure you've set your method and it's data");var e=r.result(this,"methods")[t]||{};return e.path||a.error("Make sure you've set a path for method "+t+"'"),e.name=t,e},methodDataCompose(t){return t.sendData=this.getMethodInput(t),t=this.setHttpMethod(t)},setHttpMethod(t){var e=t.sendData;return(t=r.defaults(t,{method:"object"==typeof e&&r.size(e)>0?"POST":"GET"})).method=t.method.toUpperCase(),t},getMethodInput(t){return r.result2(t,"data",this._req.body||{},[r.clone(this._req.body),t],this)},url(){return r.result(this,"urlRoot")||r.result(this.collection,"url")||a.urlError()},setApiCall(t){this.setApiUrl(t.path,t)},setApiUrl(t,e){var i=r.result(this,"urlHost")||a.urlError(1),s=r.extend({},r.clone(this.data),{_model:this,_input:e.sendData,_params:this._req.params}),o=new RegExp("((?<!:)/{1,})","g");return t=r.template(t)(s),this.urlRoot=[i,t].join("/").replace(o,"/")},sync(t,e,r){var i=[h[r.method],e,r];return s.sync.apply(this,i)},validations(t,e){return r.result2(e.methodData,e.validationsKey||"validations",{},[t,e],this)},_validate:()=>!0,validationErrors:t=>a.error({title:"Invalid Data",errors:t},0,400),setRouterParameters(t,e){t&&e||a.error("Initialize requires an object with req and res (express route variables) within"),this._req=t,a._res=this._res=e}};r.map(["Model","Collection"],t=>{a[t]=s[t].extend(r.extend(r.clone(i),n))}),a.urlError=function(t){2===t&&a.error('A "path" property must be specified in methods list for the current method'),a.error('A "urlHost" property or function must be specified')},a.error=function(t,r=0,i=500){throw new o({title:"Internal Server Error",errors:e},r,i)};var h={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.default=a,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-api-99xp.min.js.map
