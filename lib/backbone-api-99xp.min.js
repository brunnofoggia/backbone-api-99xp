/**
* @license
* backbone-api 99xp
* ----------------------------------
* v0.3.0-beta
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-api.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("validate-99xp"),require("backbone-request-99xp")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","validate-99xp","backbone-request-99xp"],e):e((t=t||self).BackboneApi={},t._,t.v,t.BackboneRequest)}(this,function(t,e,s,r){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r;var i={_res:null},a={idAttribute:"_id",auth:!1,tokenField:"accessToken",methods:{},setAuthHeader(t){return this.tokenField?(t.headers.Authorization="Bearer "+this.data[this.auth][this.tokenField],t):i.dataError("tokenField is not set")},isAuthenticated(){return!this.auth||!!this.data[this.auth]},initialize(t,s={}){this.setRouterParameters(s.req,s.res),this.options=e.defaults(e.omit(s,"req","res"),{autoexec:!0}),this.data={},"string"==typeof this.options.method&&(this.options.method=[this.options.method]),this.options.autoexec&&this.execAll()},execAll(){if(!this._methodsExecution&&(this._methodsExecution=e.clone(this.options.method)),0===e.size(this._methodsExecution))return this._methodsExecution=null,void e.bind(this.options.success,this)();var t=this._methodsExecution.shift();this.exec(t,()=>this.execAll(),this.options.error)},exec(t,s,r){var a,o=this.methodData(t);if(null!==(a=this.validate(this._req.body||{},{methodData:o,validationsKey:"inputValidations"})))return this.validationErrors(a);if(o=this.methodDataCompose(o),null!==(a=this.validate(o.sendData,{methodData:o})))return this.validationErrors(a);var h=e.bind(this.callApi,this),n=e.partial(h,t,o,s,r);return o.public||this.isAuthenticated()?n():this.auth?this.exec(this.auth,n):i.dataError(`method "${t}" is not set as public but auth is not set`)},callApi(t,s,r,i){this.setApiCall(s);var a={method:s.method,data:s.sendData,headers:e.result2(s,"headers",{},[s],this)};s.public||(a=this.setAuthHeader(a));var o=e.bind("function"==typeof s.before?s.before:(t,e,s)=>{t(e,s)},this),h=e.bind(e.partial((t,s,r,i,a)=>{this.listenToOnce(this,"sync",e.bind(()=>{this.stopListening(this),this.data[t]=this.attributes,this.attributes={};try{"function"==typeof s.success&&e.bind(s.success,this)(a,this._req.body,s),"function"==typeof r&&e.bind(r,this)(a,this._req.body,s)}catch(t){this._res.status(500).send({message:"Internal Failure (1)"})}},this)),this.listenToOnce(this,"error",e.bind((t,r)=>{this.stopListening(this);try{"function"==typeof s.error&&e.bind(s.error,this)(r,a,this._req.body,s),"function"==typeof i?e.bind(i,this)(r,a,this._req.body,s):!this._res._headerSent&&this._res.status(r.response.statusCode?r.response.statusCode:500).send(r.error)}catch(t){this._res.status(500).send({message:"Internal Failure (2)"})}},this)),this.save(null,a)},t,s,r,i),this);try{o(h,a,s)}catch(t){this._res.status(500).send({message:"Internal Failure (4)"})}},methodData(t){if(!t||!e.result(this,"methods")[t])return i.dataError("Make sure you've set your method and it's data");var s=e.result(this,"methods")[t]||{};return s.path||i.dataError("Make sure you've set a path for method "+t+"'"),s},methodDataCompose(t){return t.sendData=this.getMethodInput(t),t=this.setHttpMethod(t)},setHttpMethod(t){var s=t.sendData;return(t=e.defaults(t,{method:"object"==typeof s&&e.size(s)>0?"POST":"GET"})).method=t.method.toUpperCase(),t},getMethodInput(t){return e.result2(t,"data",this._req.body||{},[e.clone(this._req.body),t],this)},url(){return e.result(this,"urlRoot")||e.result(this.collection,"url")||i.urlError()},setApiCall(t){this.setApiUrl(t.path,t)},setApiUrl(t,s){var r=e.result(this,"urlHost")||i.urlError(1),a=e.extend({},e.clone(this.data),{_model:this,_input:s.sendData,_params:this._req.params}),o=new RegExp("((?<!:)/{1,})","g");return t=e.template(t)(a),this.urlRoot=[r,t].join("/").replace(o,"/")},sync(t,e,s){var i=[o[s.method],e,s];return r.sync.apply(this,i)},validations(t,s){return e.result2(s.methodData,s.validationsKey||"validations",{},[t,s],this)},_validate:()=>!0,validationErrors(t){this._res.status(400).send({title:"Invalid Data",errors:t})},setRouterParameters(t,e){t&&e||i.dataError("Initialize requires an object with req and res (express route variables) within"),this._req=t,i._res=this._res=e}};e.map(["Model","Collection"],t=>{i[t]=r[t].extend(e.extend(e.clone(s),a))}),i.urlError=function(t){2===t&&i.dataError('A "path" property must be specified in methods list for the current method'),i.dataError('A "urlHost" property or function must be specified')},i.dataError=function(t){if(console.error(t),i._res)return i._res.status(500).send(t);throw new Error(t)};var o={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.default=i,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-api-99xp.min.js.map
