/**
* @license
* backbone-api 99xp
* ----------------------------------
* v0.13.0-beta
*
* Copyright (c)2021 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-api.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("validate-99xp"),require("backbone-request-99xp"),require("app-exception/src/Response")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","validate-99xp","backbone-request-99xp","app-exception/src/Response"],e):e((t=t||self).BackboneApi={},t._,t.v,t.BackboneRequest,t.ExceptionResponse)}(this,function(t,e,r,s,i){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,r=r&&r.hasOwnProperty("default")?r.default:r,s=s&&s.hasOwnProperty("default")?s.default:s,i=i&&i.hasOwnProperty("default")?i.default:i;var o={_res:null},a={idAttribute:"_id",auth:!1,tokenField:"accessToken",methods:{},setAuthHeader(t){return this.tokenField?this.auth&&this.methods[this.auth]?(t.headers.Authorization="Bearer "+this.data[this.auth][this.tokenField],t):o.error("auth method is not set"):o.error("tokenField is not set")},isPublic(t=!1){return!this.auth||t},isAuthenticated(){return!this.auth||!!this.data[this.auth]},initialize(t,r={}){this.setParameters(r),this.data={},this.dataSent={},this.options=e.defaults(e.omit(r,"req","res"),{autoexec:!!r.method}),"string"==typeof this.options.method&&(this.options.method=[this.options.method]),this.options.autoexec&&this.execAll()},execAll(t,r,s){if(!t&&(t=this.options.method),!r&&(r=this.options.success),!s&&(s=this.options.error),!this._methodsExecution&&(this._methodsExecution=e.clone(t)),0===e.size(this._methodsExecution))return this._methodsExecution=null,void e.bind(r,this)();var i=this._methodsExecution.shift();this.exec(i,()=>this.execAll(t,r,s),s)},exec(t,r,s){var i,a=this.methodData(t);if(null!==(i=this.validate(this._req.body||{},{methodData:a,validationsKey:"inputValidations"})))return this.validationErrors(i);if(a=this.methodDataCompose(a),null!==(i=this.validate(a.sendData,{methodData:a})))return this.validationErrors(i);var h=e.bind(this.callApi,this),n=e.partial(h,t,a,r,s);return a.public||this.isAuthenticated()?n():this.auth?this.exec(this.auth,n,s):o.error(`method "${t}" is not set as public but auth is not set`)},callApi(t,r,s,i){this.setApiCall(r),this.dataSent[t]=r.sendData;var a=e.result2(this,"globalHeaders",{},[r],this),h=e.result2(this,"globalDefaultOptions",{},[r],this),n=e.defaults2({method:r.method,data:r.sendData,headers:e.result2(r,"headers",a,[r],this)},h);this.isPublic(r.public)||(n=this.setAuthHeader(n));var d=e.bind(e.partial(function(t,r,s,a){var h={title:"Internal Failure (4)",errors:a};"function"==typeof i?e.bind(i,this)(h,t,r,s):o.error(a,0,500)},n,this._req.body,r),this),u=e.bind("function"==typeof r.before?r.before:(t,e,r)=>{t(e,r)},this),l=e.bind(e.partial((t,r,s,i,a)=>{this.once(["sync",e.bind(()=>{this.data[t]=this.attributes,this.attributes={};try{"function"==typeof r.success&&e.bind(r.success,this)(a,this._req.body,r),"function"==typeof s&&e.bind(s,this)(a,this._req.body,r)}catch(t){var h={error:"Internal Failure (1)"};"function"==typeof i?i(h):o.error(h)}},this)],["error",e.bind((t,s)=>{try{var h;"function"==typeof r.error&&e.bind(r.error,this)(s,a,this._req.body,r),"function"==typeof i?e.bind(i,this)(s,a,this._req.body,r):o.error(null==s?void 0:s.error,0,(null==s?void 0:null===(h=s.response)||void 0===h?void 0:h.statusCode)||500)}catch(t){o.error({title:"Internal Server Error",errors:t},3)}},this)]),this.save(null,a)},t,r,s,i),this);try{var p=u(l,n,r,i);p&&p instanceof Promise&&p.then(t=>t).catch(t=>{d(t)})}catch(t){d(t)}},methodData(t){if(!t||!e.result(this,"methods")[t])return o.error("Make sure you have set your method and its data");var r=e.result(this,"methods")[t]||{};return r.path||o.error('Make sure you have set a path for method "'+t+'"'),r.name=t,r},methodDataCompose(t){return t.sendData=this.getMethodInput(t),t=this.setHttpMethod(t)},setHttpMethod(t){var r=t.sendData;return(t=e.defaults(t,{method:"object"==typeof r&&e.size(r)>0?"POST":"GET"})).method=t.method.toUpperCase(),t},getMethodInput(t){return e.result2(t,"data",this._req.body||{},[e.clone(this._req.body),t],this)},url(){return e.result(this,"urlRoot")||e.result(this.collection,"url")||o.urlError()},setApiCall(t){this.setApiUrl(t.path,t)},setApiUrl(t,r){var s=e.result(this,"urlHost")||o.urlError(1),i=e.extend({},e.clone(this.data),{_model:this,_input:r.sendData,_params:this._req.params,_options:this.options}),a=new RegExp("((?<!:)/{1,})","g");return t=e.template(t)(i),this.urlRoot=[s,t].join("/").replace(a,"/")},sync(t,e,r){var i=[h[r.method],e,r];return s.sync.apply(this,i)},set(t,r){var i=e.isArray(t),o=[t,r],a=s.Model.prototype.set.apply(this,o);return i&&(this.attributes=e.toArray(this.attributes)),a},validations(t,r){return e.result2(r.methodData,r.validationsKey||"validations",{},[t,r],this)},_validate:()=>!0,validationErrors(t){throw new i({title:"Invalid Data",errors:t},0,400)},setParameters(t){var{req:e,res:r,params:s,body:i}=t;this._req=e||{params:s||{},body:i||{}},o._res=this._res=r}};e.map(["Model","Collection"],t=>{o[t]=s[t].extend(e.extend(e.clone(r),a))}),o.urlError=function(t){2===t&&o.error('A "path" property must be specified in methods list for the current method'),o.error('A "urlHost" property or function must be specified')},o.error=function(t,e=0,r=500){throw console.error(t),new i({title:"Internal Server Error",errors:t},e,r)};var h={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.default=o,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-api-99xp.min.js.map
