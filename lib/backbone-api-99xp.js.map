{"version":3,"file":"backbone-api-99xp.js","sources":["../src/backbone-api-99xp.js"],"sourcesContent":["// Micro Service integrator plus advanced validation, formatting and control over process.\n// Mix of [express](https://github.com/expressjs/express),\n// [validate-99xp](https://github.com/brunnofoggia/validate-99xp),\n// [backbone-request-99xp](https://github.com/brunnofoggia/backbone-request-99xp)\n\n// CODE DOCUMENTED BELOW\n// --------------\n\n// --------------\n\n// Baseline setup\n// --------------\nimport _ from 'underscore-99xp';\nimport v from 'validate-99xp';\nimport BackboneRequest from 'backbone-request-99xp';\nimport ExceptionResponse from 'app-exception/src/Response';\n\nvar BackboneApi = {};\n\n// response object from express router\nBackboneApi._res = null;\n\n// Extended Functionallity for Models and Collections\nvar extended = {\n    // not meant to be used. will be used on setting api methods like POST or PUT\n    idAttribute: '_id',\n    auth: false,\n    tokenField: 'accessToken',\n    // list of methods available in the api and their configuration (paths, validations)\n    methods: {\n        //        auth: {\n        //            public: true,\n        //            path: '/a/b',\n        //            validations: {},\n        //            data: {\n        //                user: '',\n        //                pass: '',\n        //            },\n        ////            method: {}, if I dont set it, it will use a generic one\n        //\n        //        },\n        //        _sample: Sample\n        //        _sample: {\n        //            path: '/a/b',\n        //            validations: {}\n        //        }\n    },\n    //  default method applying JWT Auth\n    //  might be necessary to overwrite it\n    setAuthHeader(o) {\n        if (!this.tokenField) {\n            return BackboneApi.error('tokenField is not set');\n        } else if (!this.auth || !this.methods[this.auth]) {\n            return BackboneApi.error('auth method is not set');\n        }\n\n        o.headers.Authorization =\n            'Bearer ' + this.data[this.auth][this.tokenField];\n\n        return o;\n    },\n    isPublic(force = false) {\n        return !this.auth || force;\n    },\n    isAuthenticated() {\n        return !this.auth || !!this.data[this.auth];\n    },\n    // constructor\n    initialize(p, o = {}) {\n        this.setParameters(o);\n        // set options applying default options and ignoring router parameters\n        this.data = {};\n        this.dataSent = {};\n\n        this.options = _.defaults(_.omit(o, 'req', 'res'), {\n            autoexec: !!o.method,\n        });\n\n        // keep method as an array to have a single way on processing\n        typeof this.options.method === 'string' &&\n            (this.options.method = [this.options.method]);\n        // autoexec if isn't asked not to do it\n        this.options.autoexec && this.execAll();\n    },\n    // recursively run through methods set\n    execAll(methods, success, error) {\n        !methods && (methods = this.options.method);\n        !success && (success = this.options.success);\n        !error && (error = this.options.error);\n\n        // store a copy of methods to process them\n        !this._methodsExecution && (this._methodsExecution = _.clone(methods));\n        // stop execution when all methods were processed\n        if (_.size(this._methodsExecution) === 0) {\n            this._methodsExecution = null;\n            _.bind(success, this)();\n            return;\n        }\n        // grab first method out from list\n        var method = this._methodsExecution.shift();\n        // execute it\n        this.exec(method, () => this.execAll(methods, success, error), error);\n    },\n    // execute one method\n    exec(method, success, error) {\n        var vErr,\n            methodData = this.methodData(method);\n\n        // pre validate input\n        vErr = this.validate(this._req.body || {}, {\n            methodData: methodData,\n            validationsKey: 'inputValidations',\n        });\n        // dispach validation errors\n        if (vErr !== null) {\n            return this.validationErrors(vErr);\n        }\n\n        methodData = this.methodDataCompose(methodData);\n\n        // validate data\n        vErr = this.validate(methodData.sendData, {\n            methodData: methodData,\n        });\n        // dispach validation errors\n        if (vErr !== null) {\n            return this.validationErrors(vErr);\n        }\n\n        // set execution as callback to pass through authentication if needed\n        var fn = _.bind(this.callApi, this),\n            calledFn = _.partial(fn, method, methodData, success, error);\n        // if authorization is not needed, or is authenticated already, execute method\n        if (methodData.public || this.isAuthenticated()) {\n            return calledFn();\n        }\n        // if method is not public and there's no authentication set output an error\n        else if (!this.auth) {\n            return BackboneApi.error(\n                `method \"${method}\" is not set as public but auth is not set`,\n            );\n        }\n        // execute authentication and requested method after if\n        return this.exec(this.auth, calledFn, error);\n    },\n    // call api and trigger callbacks accordingly to what happens\n    callApi(method, methodData, success, error) {\n        this.setApiCall(methodData);\n        // request data\n        this.dataSent[method] = methodData.sendData;\n        var globalHeaders = _.result2(\n                this,\n                'globalHeaders',\n                {},\n                [methodData],\n                this,\n            ),\n            globalOptions = _.result2(\n                this,\n                'globalDefaultOptions',\n                {},\n                [methodData],\n                this,\n            ),\n            o = _.defaults2(\n                {\n                    method: methodData.method, // http method\n                    data: methodData.sendData, // request body\n                    headers: _.result2(\n                        methodData,\n                        'headers',\n                        globalHeaders,\n                        [methodData],\n                        this,\n                    ),\n                },\n                globalOptions,\n            );\n\n        // if method is private set headers\n        if (!this.isPublic(methodData.public)) {\n            o = this.setAuthHeader(o);\n        }\n\n        // before function that can be set on method config to change options or data\n        var beforeError = _.bind(\n                _.partial(\n                    function (data, o, body, methodData, e) {\n                        typeof error === 'function'\n                            ? _.bind(error, this)(data, o, body, methodData)\n                            : BackboneApi.error(\n                                  data?.error,\n                                  0,\n                                  data?.response?.statusCode || 500,\n                              );\n                    },\n                    data,\n                    o,\n                    this._req.body,\n                    methodData,\n                ),\n                this,\n            ),\n            before = _.bind(\n                typeof methodData.before === 'function'\n                    ? methodData.before\n                    : (c, _o, _methodData) => {\n                          c(_o, _methodData);\n                      },\n                this,\n            ),\n            // request function executed after before callabck\n            request = _.bind(\n                _.partial(\n                    (_method, _methodData, _success, _error, _o) => {\n                        // listeners for success or error\n                        this.once(\n                            [\n                                'sync',\n                                _.bind(() => {\n                                    // store execution results with method name in data object\n                                    this.data[_method] = this.attributes;\n                                    // empty attributes for next execution\n                                    this.attributes = {};\n\n                                    // handle possible errors inside callbacks\n                                    try {\n                                        typeof _methodData.success ===\n                                            'function' &&\n                                            _.bind(_methodData.success, this)(\n                                                _o,\n                                                this._req.body,\n                                                _methodData,\n                                            );\n                                        typeof _success === 'function' &&\n                                            _.bind(_success, this)(\n                                                _o,\n                                                this._req.body,\n                                                _methodData,\n                                            );\n                                    } catch (e) {\n                                        var data = {\n                                            error: 'Internal Failure (1)',\n                                        };\n                                        typeof _error === 'function'\n                                            ? _error(data)\n                                            : BackboneApi.error(data);\n                                    }\n                                }, this),\n                            ],\n                            [\n                                'error',\n                                _.bind((model, data) => {\n                                    // handle possible errors inside callbacks\n                                    try {\n                                        /*console.error('Internal Failure 2a');*/\n                                        typeof _methodData.error ===\n                                            'function' &&\n                                            _.bind(_methodData.error, this)(\n                                                data,\n                                                _o,\n                                                this._req.body,\n                                                _methodData,\n                                            );\n                                        typeof _error === 'function'\n                                            ? _.bind(_error, this)(\n                                                  data,\n                                                  _o,\n                                                  this._req.body,\n                                                  _methodData,\n                                              )\n                                            : BackboneApi.error(\n                                                  data?.error,\n                                                  0,\n                                                  data?.response?.statusCode ||\n                                                      500,\n                                              );\n                                    } catch (e) {\n                                        /*console.error('Internal Failure 3');*/\n                                        /*console.error(e);*/\n                                        BackboneApi.error(\n                                            {\n                                                title: 'Internal Server Error',\n                                                errors: e,\n                                            },\n                                            3,\n                                        );\n                                    }\n                                }, this),\n                            ],\n                        );\n\n                        // execute http request\n                        this.save(null, _o);\n                    },\n                    method,\n                    methodData,\n                    success,\n                    error,\n                ),\n                this,\n            );\n\n        // handle possible errors inside before function\n        try {\n            var rPromise = before(request, o, methodData, error);\n            if (rPromise && rPromise instanceof Promise) {\n                rPromise\n                    .then((f) => f)\n                    .catch((e) => {\n                        beforeError(e);\n                    });\n            }\n        } catch (e) {\n            var data = {\n                title: 'Internal Failure (4)',\n                errors: e,\n            };\n\n            beforeError(e);\n        }\n    },\n    // getter for methods data. ensure data for method asked is set\n    methodData(method) {\n        if (!method || !_.result(this, 'methods')[method]) {\n            return BackboneApi.error(\n                'Make sure you have set your method and its data',\n            );\n        }\n\n        var methodData = _.result(this, 'methods')[method] || {};\n        if (!methodData.path) {\n            BackboneApi.error(\n                'Make sure you have set a path for method \"' + method + '\"',\n            );\n        }\n        methodData.name = method;\n        return methodData;\n    },\n    methodDataCompose(methodData) {\n        methodData.sendData = this.getMethodInput(methodData);\n        methodData = this.setHttpMethod(methodData);\n        return methodData;\n    },\n    // get HTTP method from method configuration. if needed set a default HTTP method accordingly to method data input\n    setHttpMethod(methodData) {\n        var data = methodData.sendData;\n        methodData = _.defaults(methodData, {\n            method:\n                typeof data === 'object' && _.size(data) > 0 ? 'POST' : 'GET',\n        });\n        methodData.method = methodData.method.toUpperCase();\n\n        return methodData;\n    },\n    // get \"data\" from method configuration (can be an object or function) or req.body instead\n    getMethodInput(methodData) {\n        return _.result2(\n            methodData,\n            'data',\n            this._req.body || {},\n            [_.clone(this._req.body), methodData],\n            this,\n        );\n    },\n    // replaces common behavior of backbone to ensure no id nonwanted will be added in Api URLs\n    url() {\n        return (\n            _.result(this, 'urlRoot') ||\n            _.result(this.collection, 'url') ||\n            BackboneApi.urlError()\n        );\n    },\n    // set asked method data for the request to be executed\n    setApiCall(methodData) {\n        this.setApiUrl(methodData.path, methodData);\n    },\n    // merge urlHost with the correct path for method asked. also render path as a template to make possible having attributes on it\n    setApiUrl(path, methodData) {\n        var host = _.result(this, 'urlHost') || BackboneApi.urlError(1),\n            data = _.extend({}, _.clone(this.data), {\n                _model: this,\n                _input: methodData.sendData,\n                _params: this._req.params,\n            }),\n            pathfix = new RegExp('((?<!:)/{1,})', 'g');\n\n        path = _.template(path)(data);\n\n        return (this.urlRoot = [host, path].join('/').replace(pathfix, '/'));\n    },\n    // Customization of sync to use BackboneRequest.sync\n    sync(method, model, options) {\n        method = methodMap[options.method];\n        var args = [method, model, options];\n        return BackboneRequest.sync.apply(this, args);\n    },\n    // Avoid response arrays from being converted to assoc objects\n    set(models, options) {\n        var isArray = _.isArray(models),\n            args = [models, options],\n            r = BackboneRequest.Model.prototype.set.apply(this, args);\n        isArray && (this.attributes = _.toArray(this.attributes));\n        return r;\n    },\n    // inherit validations from method configuration\n    validations(a, o) {\n        var vl = _.result2(\n            o.methodData,\n            o.validationsKey || 'validations',\n            {},\n            [a, o],\n            this,\n        );\n        return vl;\n    },\n    // Skip own validations. The ones that matter are method validations\n    _validate() {\n        return true;\n    },\n    // Dispatcher of validation errors\n    validationErrors(err) {\n        throw new ExceptionResponse(\n            {\n                title: 'Invalid Data',\n                errors: err,\n            },\n            0,\n            400,\n        );\n    },\n    // Store req and res objects from express router. Those are necessary to access input data and to send information to the client\n    setParameters(o) {\n        var { req, res, params, body } = o;\n        this._req = req || { params: params || {}, body: body || {} };\n        BackboneApi._res = this._res = res;\n    },\n};\n\n// add extension and validate to our classes\n_.map(['Model', 'Collection'], (x) => {\n    BackboneApi[x] = BackboneRequest[x].extend(_.extend(_.clone(v), extended));\n});\n\n// Throw an error when a URL is needed, and none is supplied.\nBackboneApi.urlError = function (code) {\n    if (code === 2) {\n        BackboneApi.error(\n            'A \"path\" property must be specified in methods list for the current method',\n        );\n    }\n    BackboneApi.error('A \"urlHost\" property or function must be specified');\n};\n\n// Throw an error when some DATA is needed, and none is supplied.\nBackboneApi.error = function (err, code = 0, status = 500) {\n    console.error(err);\n    throw new ExceptionResponse(\n        {\n            title: 'Internal Server Error',\n            errors: err,\n        },\n        code,\n        status,\n    );\n};\n\n// Map from CRUD to HTTP for our default `Backbone.sync` implementation.\nvar methodMap = {\n    POST: 'create',\n    PUT: 'update',\n    PATCH: 'patch',\n    DELETE: 'delete',\n    GET: 'read',\n};\n\nexport default BackboneApi;\n"],"names":["BackboneApi","_res","extended","idAttribute","auth","tokenField","methods","setAuthHeader","o","error","headers","Authorization","data","isPublic","force","isAuthenticated","initialize","p","setParameters","dataSent","options","_","defaults","omit","autoexec","method","execAll","success","_methodsExecution","clone","size","bind","shift","exec","vErr","methodData","validate","_req","body","validationsKey","validationErrors","methodDataCompose","sendData","fn","callApi","calledFn","partial","public","setApiCall","globalHeaders","result2","globalOptions","defaults2","beforeError","e","response","statusCode","before","c","_o","_methodData","request","_method","_success","_error","once","attributes","model","title","errors","save","rPromise","Promise","then","f","catch","result","path","name","getMethodInput","setHttpMethod","toUpperCase","url","collection","urlError","setApiUrl","host","extend","_model","_input","_params","params","pathfix","RegExp","template","urlRoot","join","replace","sync","methodMap","args","BackboneRequest","apply","set","models","isArray","r","Model","prototype","toArray","validations","a","vl","_validate","err","ExceptionResponse","req","res","map","x","v","code","status","console","POST","PUT","PATCH","DELETE","GET"],"mappings":"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"}