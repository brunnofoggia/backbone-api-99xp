/**
* @license
* backbone-api 99xp
* ----------------------------------
* v0.12.2-beta
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-api.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("validate-99xp"),require("backbone-request-99xp"),require("app-exception/src/Response")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","validate-99xp","backbone-request-99xp","app-exception/src/Response"],e):e((t=t||self).BackboneApi={},t._,t.v,t.BackboneRequest,t.ExceptionResponse)}(this,function(t,e,r,s,i){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,r=r&&r.hasOwnProperty("default")?r.default:r,s=s&&s.hasOwnProperty("default")?s.default:s,i=i&&i.hasOwnProperty("default")?i.default:i;var o={_res:null},a={idAttribute:"_id",auth:!1,tokenField:"accessToken",methods:{},setAuthHeader(t){return this.tokenField?this.auth&&this.methods[this.auth]?(t.headers.Authorization="Bearer "+this.data[this.auth][this.tokenField],t):o.error("auth method is not set"):o.error("tokenField is not set")},isPublic(t=!1){return!this.auth||t},isAuthenticated(){return!this.auth||!!this.data[this.auth]},initialize(t,r={}){this.setRouterParameters(r.req,r.res),this.options=e.defaults(e.omit(r,"req","res"),{autoexec:!0}),this.data={},this.dataSent={},"string"==typeof this.options.method&&(this.options.method=[this.options.method]),this.options.autoexec&&this.execAll()},execAll(){if(!this._methodsExecution&&(this._methodsExecution=e.clone(this.options.method)),0===e.size(this._methodsExecution))return this._methodsExecution=null,void e.bind(this.options.success,this)();var t=this._methodsExecution.shift();this.exec(t,()=>this.execAll(),this.options.error)},exec(t,r,s){var i,a=this.methodData(t);if(null!==(i=this.validate(this._req.body||{},{methodData:a,validationsKey:"inputValidations"})))return this.validationErrors(i);if(a=this.methodDataCompose(a),null!==(i=this.validate(a.sendData,{methodData:a})))return this.validationErrors(i);var n=e.bind(this.callApi,this),h=e.partial(n,t,a,r,s);return a.public||this.isAuthenticated()?h():this.auth?this.exec(this.auth,h,s):o.error(`method "${t}" is not set as public but auth is not set`)},callApi(t,r,s,i){this.setApiCall(r),this.dataSent[t]=r.sendData;var a=e.result2(this,"globalHeaders",{},[r],this),n=e.result2(this,"globalDefaultOptions",{},[r],this),h=e.defaults2({method:r.method,data:r.sendData,headers:e.result2(r,"headers",a,[r],this)},n);this.isPublic(r.public)||(h=this.setAuthHeader(h));var d=e.bind("function"==typeof r.before?r.before:(t,e,r)=>{t(e,r)},this),u=e.bind(e.partial((t,r,s,i,a)=>{this.once(["sync",e.bind(()=>{this.data[t]=this.attributes,this.attributes={};try{"function"==typeof r.success&&e.bind(r.success,this)(a,this._req.body,r),"function"==typeof s&&e.bind(s,this)(a,this._req.body,r)}catch(t){var n={error:"Internal Failure (1)"};"function"==typeof i?i(n):o.error(n)}},this)],["error",e.bind((t,s)=>{try{var n;"function"==typeof r.error&&e.bind(r.error,this)(s,a,this._req.body,r),"function"==typeof i?e.bind(i,this)(s,a,this._req.body,r):o.error(null==s?void 0:s.error,0,(null==s?void 0:null===(n=s.response)||void 0===n?void 0:n.statusCode)||500)}catch(t){o.error({title:"Internal Server Error",errors:t},3)}},this)]),this.save(null,a)},t,r,s,i),this);try{d(u,h,r,i)}catch(t){var l,p={title:"Internal Failure (4)",errors:t};"function"==typeof i?e.bind(i,this)(p,h,this._req.body,r):o.error(null==p?void 0:p.error,0,(null==p?void 0:null===(l=p.response)||void 0===l?void 0:l.statusCode)||500)}},methodData(t){if(!t||!e.result(this,"methods")[t])return o.error("Make sure you've set your method and it's data");var r=e.result(this,"methods")[t]||{};return r.path||o.error("Make sure you've set a path for method "+t+"'"),r.name=t,r},methodDataCompose(t){return t.sendData=this.getMethodInput(t),t=this.setHttpMethod(t)},setHttpMethod(t){var r=t.sendData;return(t=e.defaults(t,{method:"object"==typeof r&&e.size(r)>0?"POST":"GET"})).method=t.method.toUpperCase(),t},getMethodInput(t){return e.result2(t,"data",this._req.body||{},[e.clone(this._req.body),t],this)},url(){return e.result(this,"urlRoot")||e.result(this.collection,"url")||o.urlError()},setApiCall(t){this.setApiUrl(t.path,t)},setApiUrl(t,r){var s=e.result(this,"urlHost")||o.urlError(1),i=e.extend({},e.clone(this.data),{_model:this,_input:r.sendData,_params:this._req.params}),a=new RegExp("((?<!:)/{1,})","g");return t=e.template(t)(i),this.urlRoot=[s,t].join("/").replace(a,"/")},sync(t,e,r){var i=[n[r.method],e,r];return s.sync.apply(this,i)},validations(t,r){return e.result2(r.methodData,r.validationsKey||"validations",{},[t,r],this)},_validate:()=>!0,validationErrors(t){throw new i({title:"Invalid Data",errors:t},0,400)},setRouterParameters(t,e){t&&e||o.error("Initialize requires an object with req and res (express route variables) within"),this._req=t,o._res=this._res=e}};e.map(["Model","Collection"],t=>{o[t]=s[t].extend(e.extend(e.clone(r),a))}),o.urlError=function(t){2===t&&o.error('A "path" property must be specified in methods list for the current method'),o.error('A "urlHost" property or function must be specified')},o.error=function(t,e=0,r=500){throw new i({title:"Internal Server Error",errors:t},e,r)};var n={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.default=o,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-api-99xp.min.js.map
