/**
* @license
* backbone-api 99xp
* ----------------------------------
* v0.8.0-beta
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-api.99xp.org
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("underscore-99xp"),require("validate-99xp"),require("backbone-request-99xp"),require("app-exception")):"function"==typeof define&&define.amd?define(["exports","underscore-99xp","validate-99xp","backbone-request-99xp","app-exception"],e):e((t=t||self).BackboneApi={},t._,t.v,t.BackboneRequest,t.AppException)}(this,function(t,e,r,i,s){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i,s=s&&s.hasOwnProperty("default")?s.default:s;var o={_res:null},a={idAttribute:"_id",auth:!1,tokenField:"accessToken",methods:{},setAuthHeader(t){return this.tokenField?(t.headers.Authorization="Bearer "+this.data[this.auth][this.tokenField],t):o.error("tokenField is not set")},isAuthenticated(){return!this.auth||!!this.data[this.auth]},initialize(t,r={}){this.setRouterParameters(r.req,r.res),this.options=e.defaults(e.omit(r,"req","res"),{autoexec:!0}),this.data={},this.dataSent={},"string"==typeof this.options.method&&(this.options.method=[this.options.method]),this.options.autoexec&&this.execAll()},execAll(){if(!this._methodsExecution&&(this._methodsExecution=e.clone(this.options.method)),0===e.size(this._methodsExecution))return this._methodsExecution=null,void e.bind(this.options.success,this)();var t=this._methodsExecution.shift();this.exec(t,()=>this.execAll(),this.options.error)},exec(t,r,i){var s,a=this.methodData(t);if(null!==(s=this.validate(this._req.body||{},{methodData:a,validationsKey:"inputValidations"})))return this.validationErrors(s);if(a=this.methodDataCompose(a),null!==(s=this.validate(a.sendData,{methodData:a})))return this.validationErrors(s);var n=e.bind(this.callApi,this),h=e.partial(n,t,a,r,i);return a.public||this.isAuthenticated()?h():this.auth?this.exec(this.auth,h,i):o.error(`method "${t}" is not set as public but auth is not set`)},callApi(t,r,i,s){this.setApiCall(r),this.dataSent[t]=r.sendData;var a={method:r.method,data:r.sendData,headers:e.result2(r,"headers",{},[r],this)};r.public||(a=this.setAuthHeader(a));var n=e.bind("function"==typeof r.before?r.before:(t,e,r)=>{t(e,r)},this),h=e.bind(e.partial((t,r,i,s,a)=>{this.once(["sync",e.bind(()=>{this.data[t]=this.attributes,this.attributes={};try{"function"==typeof r.success&&e.bind(r.success,this)(a,this._req.body,r),"function"==typeof i&&e.bind(i,this)(a,this._req.body,r)}catch(t){var n={error:"Internal Failure (1)"};"function"==typeof s?s(n):o.error(n)}},this)],["error",e.bind((t,i)=>{try{var n;"function"==typeof r.error&&e.bind(r.error,this)(i,a,this._req.body,r),"function"==typeof s?e.bind(s,this)(i,a,this._req.body,r):o.error(null==i?void 0:i.error,0,(null==i?void 0:null===(n=i.response)||void 0===n?void 0:n.statusCode)||500)}catch(t){o.error({title:"Internal Server Error",errors:t},3)}},this)]),this.save(null,a)},t,r,i,s),this);try{n(h,a,r,s)}catch(t){var d,u={title:"Internal Failure (4)",errors:t};"function"==typeof s?e.bind(s,this)(u,a,this._req.body,r):o.error(null==u?void 0:u.error,0,(null==u?void 0:null===(d=u.response)||void 0===d?void 0:d.statusCode)||500)}},methodData(t){if(!t||!e.result(this,"methods")[t])return o.error("Make sure you've set your method and it's data");var r=e.result(this,"methods")[t]||{};return r.path||o.error("Make sure you've set a path for method "+t+"'"),r.name=t,r},methodDataCompose(t){return t.sendData=this.getMethodInput(t),t=this.setHttpMethod(t)},setHttpMethod(t){var r=t.sendData;return(t=e.defaults(t,{method:"object"==typeof r&&e.size(r)>0?"POST":"GET"})).method=t.method.toUpperCase(),t},getMethodInput(t){return e.result2(t,"data",this._req.body||{},[e.clone(this._req.body),t],this)},url(){return e.result(this,"urlRoot")||e.result(this.collection,"url")||o.urlError()},setApiCall(t){this.setApiUrl(t.path,t)},setApiUrl(t,r){var i=e.result(this,"urlHost")||o.urlError(1),s=e.extend({},e.clone(this.data),{_model:this,_input:r.sendData,_params:this._req.params}),a=new RegExp("((?<!:)/{1,})","g");return t=e.template(t)(s),this.urlRoot=[i,t].join("/").replace(a,"/")},sync(t,e,r){var s=[n[r.method],e,r];return i.sync.apply(this,s)},validations(t,r){return e.result2(r.methodData,r.validationsKey||"validations",{},[t,r],this)},_validate:()=>!0,validationErrors(t){throw new s({title:"Invalid Data",errors:t},0,400)},setRouterParameters(t,e){t&&e||o.error("Initialize requires an object with req and res (express route variables) within"),this._req=t,o._res=this._res=e}};e.map(["Model","Collection"],t=>{o[t]=i[t].extend(e.extend(e.clone(r),a))}),o.urlError=function(t){2===t&&o.error('A "path" property must be specified in methods list for the current method'),o.error('A "urlHost" property or function must be specified')},o.error=function(t,e=0,r=500){throw new s({title:"Internal Server Error",errors:t},e,r)};var n={POST:"create",PUT:"update",PATCH:"patch",DELETE:"delete",GET:"read"};t.default=o,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-api-99xp.min.js.map
