{"version":3,"file":"backbone-api-99xp.js","sources":["../src/backbone-api-99xp.js"],"sourcesContent":["// Micro Service integrator plus advanced validation, formatting and control over process.\n// Mix of [express](https://github.com/expressjs/express), \n// [validate-99xp](https://github.com/brunnofoggia/validate-99xp), \n// [backbone-request-99xp](https://github.com/brunnofoggia/backbone-request-99xp)\n\n\n// CODE DOCUMENTED BELOW\n// --------------\n\n// --------------\n\n// Baseline setup\n// --------------\nimport _ from 'underscore-99xp';\nimport v from 'validate-99xp';\nimport BackboneRequest from 'backbone-request-99xp';\nimport ExceptionResponse from 'app-exception/src/Response';\n\nvar BackboneApi = {};\n\n// response object from express router\nBackboneApi._res = null;\n\n// Extended Functionallity for Models and Collections\nvar extended = {\n    // not meant to be used. will be used on setting api methods like POST or PUT\n    idAttribute: '_id',\n    auth: false,\n    tokenField: 'accessToken',\n    // list of methods available in the api and their configuration (paths, validations)\n    methods: {\n        //        auth: {\n        //            public: true,\n        //            path: '/a/b',\n        //            validations: {},\n        //            data: {\n        //                user: '',\n        //                pass: '',\n        //            },\n        ////            method: {}, if I dont set it, it will use a generic one\n        //            \n        //        },\n        //        _sample: Sample\n        //        _sample: {\n        //            path: '/a/b',\n        //            validations: {}\n        //        }\n    },\n    //  default method applying JWT Auth\n    //  might be necessary to overwrite it\n    setAuthHeader(o) {\n        if (!this.tokenField) {\n            return BackboneApi.error('tokenField is not set');\n        } else if(!this.auth || !this.methods[this.auth]) {\n            return BackboneApi.error('auth method is not set');\n        }\n\n        o.headers.Authorization = 'Bearer ' + this.data[this.auth][this.tokenField];\n\n        return o;\n    },\n    isPublic(force=false) {\n        return !this.auth || force;\n    },\n    isAuthenticated() {\n        return !this.auth || !!this.data[this.auth];\n    },\n    // constructor\n    initialize(p, o = {}) {\n        this.setRouterParameters(o.req, o.res);\n        // set options applying default options and ignoring router parameters\n        this.options = _.defaults(_.omit(o, 'req', 'res'), {\n            autoexec: true\n        });\n        this.data = {};\n        this.dataSent = {};\n\n        // keep method as an array to have a single way on processing\n        typeof this.options.method === 'string' && (this.options.method = [this.options.method]);\n        // autoexec if isn't asked not to do it\n        this.options.autoexec && this.execAll();\n    },\n    // recursively run through methods set\n    execAll() {\n        // store a copy of methods to process them\n        !this._methodsExecution && (this._methodsExecution = _.clone(this.options.method));\n        // stop execution when all methods were processed\n        if (_.size(this._methodsExecution) === 0) {\n            this._methodsExecution = null;\n            _.bind(this.options.success, this)();\n            return;\n        }\n        // grab first method out from list\n        var method = this._methodsExecution.shift();\n        // execute it\n        this.exec(method, () => this.execAll(), this.options.error);\n    },\n    // execute one method\n    exec(method, success, error) {\n        var vErr,\n            methodData = this.methodData(method);\n\n        // pre validate input\n        vErr = this.validate(this._req.body || {}, {\n            methodData: methodData,\n            validationsKey: 'inputValidations'\n        });\n        // dispach validation errors\n        if (vErr !== null) {\n            return this.validationErrors(vErr);\n        }\n\n        methodData = this.methodDataCompose(methodData);\n        \n        // validate data\n        vErr = this.validate(methodData.sendData, {\n            methodData: methodData\n        });\n        // dispach validation errors\n        if (vErr !== null) {\n            return this.validationErrors(vErr);\n        }\n\n        // set execution as callback to pass through authentication if needed\n        var fn = _.bind(this.callApi, this),\n            calledFn = _.partial(fn, method, methodData, success, error);\n        // if authorization is not needed, or is authenticated already, execute method\n        if (methodData.public || this.isAuthenticated()) {\n            return calledFn();\n        }\n        // if method is not public and there's no authentication set output an error\n        else if (!this.auth) {\n            return BackboneApi.error(`method \"${method}\" is not set as public but auth is not set`);\n        }\n        // execute authentication and requested method after if\n        return this.exec(this.auth, calledFn, error);\n    },\n    // call api and trigger callbacks accordingly to what happens\n    callApi(method, methodData, success, error) {\n        this.setApiCall(methodData);\n        // request data\n        this.dataSent[method] = methodData.sendData;\n        var globalHeaders = _.result2(this, 'globalHeaders', {}, [methodData], this),\n            o = {\n            method: methodData.method, // http method\n            data: methodData.sendData, // request body\n            headers: _.result2(methodData, 'headers', globalHeaders, [methodData], this)\n        };\n\n        // if method is private set headers\n        if (!this.isPublic(methodData.public)) {\n            o = this.setAuthHeader(o);\n        }\n        \n        // before function that can be set on method config to change options or data\n        var before = _.bind(typeof methodData.before === 'function' ? methodData.before : (c, _o, _methodData) => {\n                c(_o, _methodData);\n            }, this),\n            // request function executed after before callabck\n            request = _.bind(_.partial((_method, _methodData, _success, _error, _o) => {\n                // listeners for success or error\n                this.once(['sync', _.bind(() => {\n                    // store execution results with method name in data object\n                    this.data[_method] = this.attributes;\n                    // empty attributes for next execution\n                    this.attributes = {};\n\n                    // handle possible errors inside callbacks\n                    try {\n                        typeof _methodData.success === 'function' && _.bind(_methodData.success, this)(_o, this._req.body, _methodData);\n                        typeof _success === 'function' && _.bind(_success, this)(_o, this._req.body, _methodData);\n                    } catch (e) {\n                        var data = { error: 'Internal Failure (1)' };\n                        typeof _error === 'function' ? _error(data) : (BackboneApi.error(data));\n                    }\n                }, this)], ['error', _.bind((model, data) => {\n                    // handle possible errors inside callbacks\n                    try {\n                        /*console.error('Internal Failure 2a');*/\n                        typeof _methodData.error === 'function' && _.bind(_methodData.error, this)(data, _o, this._req.body, _methodData);\n                        typeof _error === 'function' ? _.bind(_error, this)(data, _o, this._req.body, _methodData) : (BackboneApi.error(data?.error, 0, data?.response?.statusCode || 500));\n                    } catch (e) {\n                        /*console.error('Internal Failure 3');*/\n                        /*console.error(e);*/\n                        BackboneApi.error({\n                            title: 'Internal Server Error',\n                            errors: e\n                        }, 3);\n                    }\n                }, this)\n                ]);\n\n                // execute http request\n                this.save(null, _o);\n            }, method, methodData, success, error), this);\n\n        // handle possible errors inside before function\n        try {\n            before(request, o, methodData, error);\n        } catch (e) {\n            var data = {\n                title: 'Internal Failure (4)',\n                errors: e\n            };\n            typeof error === 'function' ? _.bind(error, this)(data, o, this._req.body, methodData) : (BackboneApi.error(data?.error, 0, data?.response?.statusCode || 500));\n        }\n    },\n    // getter for methods data. ensure data for method asked is set\n    methodData(method) {\n        if (!method || !_.result(this, 'methods')[method]) {\n            return BackboneApi.error('Make sure you\\'ve set your method and it\\'s data');\n        }\n\n        var methodData = _.result(this, 'methods')[method] || {};\n        if (!methodData.path) {\n            BackboneApi.error('Make sure you\\'ve set a path for method ' + method + '\\'');\n        }\n        methodData.name = method;\n        return methodData;\n    },\n    methodDataCompose(methodData) {\n        methodData.sendData = this.getMethodInput(methodData);\n        methodData = this.setHttpMethod(methodData);\n        return methodData;\n    },\n    // get HTTP method from method configuration. if needed set a default HTTP method accordingly to method data input\n    setHttpMethod(methodData) {\n        var data = methodData.sendData;\n        methodData = _.defaults(methodData, {\n            method: (typeof data === 'object' && _.size(data) > 0 ? 'POST' : 'GET')\n        });\n        methodData.method = methodData.method.toUpperCase();\n\n        return methodData;\n    },\n    // get \"data\" from method configuration (can be an object or function) or req.body instead\n    getMethodInput(methodData) {\n        return _.result2(methodData, 'data', this._req.body || {}, [_.clone(this._req.body), methodData], this);\n    },\n    // replaces common behavior of backbone to ensure no id nonwanted will be added in Api URLs\n    url() {\n        return _.result(this, 'urlRoot') ||\n            _.result(this.collection, 'url') ||\n            BackboneApi.urlError();\n    },\n    // set asked method data for the request to be executed\n    setApiCall(methodData) {\n        this.setApiUrl(methodData.path, methodData);\n    },\n    // merge urlHost with the correct path for method asked. also render path as a template to make possible having attributes on it\n    setApiUrl(path, methodData) {\n        var host = _.result(this, 'urlHost') || BackboneApi.urlError(1),\n            data = _.extend({}, _.clone(this.data), {\n                _model: this,\n                _input: methodData.sendData,\n                _params: this._req.params\n            }),\n            pathfix = new RegExp('((?<!\\:)\\/{1,})', 'g');\n\n        path = _.template(path)(data);\n\n        return this.urlRoot = [host, path].join('/').replace(pathfix, '/');\n    },\n    // Customization of sync to use BackboneRequest.sync\n    sync(method, model, options) {\n        method = methodMap[options.method];\n        var args = [method, model, options];\n        return BackboneRequest.sync.apply(this, args);\n    },\n    // inherit validations from method configuration\n    validations(a, o) {\n        var vl = _.result2(o.methodData, o.validationsKey || 'validations', {}, [a, o], this);\n        return vl;\n    },\n    // Skip own validations. The ones that matter are method validations\n    _validate() {\n        return true;\n    },\n    // Dispatcher of validation errors\n    validationErrors(err) {\n        throw new ExceptionResponse({\n            title: 'Invalid Data',\n            errors: err\n        }, 0, 400);\n    },\n    // Store req and res objects from express router. Those are necessary to access input data and to send information to the client\n    setRouterParameters(req, res) {\n        if (!req || !res) {\n            BackboneApi.error('Initialize requires an object with req and res (express route variables) within');\n        }\n\n        this._req = req;\n        BackboneApi._res = this._res = res;\n    },\n};\n\n// add extension and validate to our classes\n_.map(['Model', 'Collection'], (x) => {\n    BackboneApi[x] = BackboneRequest[x].extend(_.extend(_.clone(v), extended));\n});\n\n// Throw an error when a URL is needed, and none is supplied.\nBackboneApi.urlError = function(code) {\n    if (code === 2) {\n        BackboneApi.error('A \"path\" property must be specified in methods list for the current method');\n    }\n    BackboneApi.error('A \"urlHost\" property or function must be specified');\n};\n\n// Throw an error when some DATA is needed, and none is supplied.\nBackboneApi.error = function(err, code = 0, status = 500) {\n    throw new ExceptionResponse({\n        title: 'Internal Server Error',\n        errors: err\n    }, code, status);\n};\n\n// Map from CRUD to HTTP for our default `Backbone.sync` implementation.\nvar methodMap = {\n    'POST': 'create',\n    'PUT': 'update',\n    'PATCH': 'patch',\n    'DELETE': 'delete',\n    'GET': 'read'\n};\n\n\nexport default BackboneApi;\n"],"names":["BackboneApi","_res","extended","idAttribute","auth","tokenField","methods","setAuthHeader","o","error","headers","Authorization","data","isPublic","force","isAuthenticated","initialize","p","setRouterParameters","req","res","options","_","defaults","omit","autoexec","dataSent","method","execAll","_methodsExecution","clone","size","bind","success","shift","exec","vErr","methodData","validate","_req","body","validationsKey","validationErrors","methodDataCompose","sendData","fn","callApi","calledFn","partial","public","setApiCall","globalHeaders","result2","before","c","_o","_methodData","request","_method","_success","_error","once","attributes","e","model","response","statusCode","title","errors","save","result","path","name","getMethodInput","setHttpMethod","toUpperCase","url","collection","urlError","setApiUrl","host","extend","_model","_input","_params","params","pathfix","RegExp","template","urlRoot","join","replace","sync","methodMap","args","BackboneRequest","apply","validations","a","vl","_validate","err","ExceptionResponse","map","x","v","code","status"],"mappings":"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"}